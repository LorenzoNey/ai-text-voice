<Window x:Class="WisprClone.Views.OverlayWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="WisprClone"
        WindowStyle="None"
        AllowsTransparency="True"
        Background="Transparent"
        Topmost="True"
        ShowInTaskbar="False"
        ResizeMode="NoResize"
        Width="420" Height="160"
        Left="{Binding WindowLeft, Mode=TwoWay}"
        Top="{Binding WindowTop, Mode=TwoWay}">

    <Window.Resources>
        <!-- Bool to Visibility converter -->
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>

        <!-- Pulse animation for listening state -->
        <Storyboard x:Key="PulseAnimation" RepeatBehavior="Forever">
            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                             From="1" To="0.4" Duration="0:0:0.6"
                             AutoReverse="True"/>
        </Storyboard>

        <!-- Status color based on state -->
        <Style x:Key="StatusIndicatorStyle" TargetType="Ellipse">
            <Setter Property="Width" Value="12"/>
            <Setter Property="Height" Value="12"/>
            <Setter Property="Fill" Value="{Binding StatusColor}"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsListening}" Value="True">
                    <DataTrigger.EnterActions>
                        <BeginStoryboard x:Name="StartPulse" Storyboard="{StaticResource PulseAnimation}"/>
                    </DataTrigger.EnterActions>
                    <DataTrigger.ExitActions>
                        <StopStoryboard BeginStoryboardName="StartPulse"/>
                    </DataTrigger.ExitActions>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- Waveform bar style -->
        <Style x:Key="WaveBarStyle" TargetType="Rectangle">
            <Setter Property="Width" Value="3"/>
            <Setter Property="Fill" Value="#90FFFFFF"/>
            <Setter Property="RadiusX" Value="1.5"/>
            <Setter Property="RadiusY" Value="1.5"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="1,0"/>
        </Style>

        <!-- Button style -->
        <Style x:Key="CloseButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="#80FFFFFF"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Width" Value="24"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#30FFFFFF"/>
                    <Setter Property="Foreground" Value="White"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Subtle scrollbar thumb style -->
        <Style x:Key="SubtleScrollBarThumb" TargetType="Thumb">
            <Setter Property="Width" Value="3"/>
            <Setter Property="Background" Value="#50FFFFFF"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Thumb">
                        <Border x:Name="ThumbBorder"
                                Background="{TemplateBinding Background}"
                                CornerRadius="1.5"
                                Width="3"/>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="ThumbBorder" Property="Background" Value="#80FFFFFF"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Subtle vertical scrollbar style -->
        <Style x:Key="SubtleVerticalScrollBar" TargetType="ScrollBar">
            <Setter Property="Width" Value="6"/>
            <Setter Property="MinWidth" Value="6"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ScrollBar">
                        <Border Background="Transparent" Width="6">
                            <Track x:Name="PART_Track" IsDirectionReversed="True" Width="3">
                                <Track.Thumb>
                                    <Thumb Style="{StaticResource SubtleScrollBarThumb}"/>
                                </Track.Thumb>
                            </Track>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Subtle ScrollViewer style for dropdowns -->
        <Style x:Key="SubtleScrollViewerStyle" TargetType="ScrollViewer">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ScrollViewer">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <ScrollContentPresenter Grid.Column="0" Margin="0,0,2,0"/>
                            <ScrollBar x:Name="PART_VerticalScrollBar"
                                       Grid.Column="1"
                                       Style="{StaticResource SubtleVerticalScrollBar}"
                                       Value="{TemplateBinding VerticalOffset}"
                                       Maximum="{TemplateBinding ScrollableHeight}"
                                       ViewportSize="{TemplateBinding ViewportHeight}"
                                       Visibility="{TemplateBinding ComputedVerticalScrollBarVisibility}"/>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Ghost Chip ComboBox Style for subtle footer selectors -->
        <Style x:Key="GhostChipComboBoxStyle" TargetType="ComboBox">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="#70FFFFFF"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="Padding" Value="6,3"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Height" Value="Auto"/>
            <Setter Property="MinWidth" Value="50"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid>
                            <Border x:Name="MainBorder"
                                    Background="{TemplateBinding Background}"
                                    CornerRadius="10"
                                    Padding="{TemplateBinding Padding}"
                                    SnapsToDevicePixels="True">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Selected text -->
                                    <ContentPresenter Grid.Column="0"
                                                      Content="{TemplateBinding SelectionBoxItem}"
                                                      ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                                      VerticalAlignment="Center"
                                                      HorizontalAlignment="Left"
                                                      IsHitTestVisible="False"/>

                                    <!-- Chevron (hidden by default, points up) -->
                                    <Path x:Name="Chevron"
                                          Grid.Column="1"
                                          Data="M 0 4 L 4 0 L 8 4"
                                          Stroke="#60FFFFFF"
                                          StrokeThickness="1.2"
                                          VerticalAlignment="Center"
                                          HorizontalAlignment="Center"
                                          Margin="6,0,0,0"
                                          Width="8"
                                          Height="5"
                                          Visibility="Collapsed"
                                          Stretch="Uniform"
                                          RenderTransformOrigin="0.5,0.5">
                                        <Path.RenderTransform>
                                            <RotateTransform Angle="0"/>
                                        </Path.RenderTransform>
                                    </Path>
                                </Grid>
                            </Border>

                            <!-- Invisible toggle button for click handling -->
                            <ToggleButton x:Name="PART_ToggleButton"
                                          IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                          Focusable="False"
                                          Background="Transparent"
                                          BorderThickness="0"
                                          Opacity="0"/>

                            <!-- Popup positioned above -->
                            <Popup x:Name="PART_Popup"
                                   Placement="Top"
                                   PlacementTarget="{Binding ElementName=MainBorder}"
                                   IsOpen="{TemplateBinding IsDropDownOpen}"
                                   AllowsTransparency="True"
                                   Focusable="False"
                                   PopupAnimation="Fade"
                                   VerticalOffset="-4">
                                <Border Background="#F0202020"
                                        BorderBrush="#40FFFFFF"
                                        BorderThickness="1"
                                        CornerRadius="8"
                                        Padding="4"
                                        MinWidth="{TemplateBinding ActualWidth}"
                                        MaxHeight="200">
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="12"
                                                          ShadowDepth="0"
                                                          Opacity="0.4"
                                                          Color="Black"/>
                                    </Border.Effect>
                                    <ScrollViewer Style="{StaticResource SubtleScrollViewerStyle}"
                                                  VerticalScrollBarVisibility="Auto"
                                                  HorizontalScrollBarVisibility="Disabled">
                                        <StackPanel IsItemsHost="True"/>
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Grid>

                        <ControlTemplate.Triggers>
                            <!-- Hover state -->
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="MainBorder" Property="Background" Value="#15FFFFFF"/>
                                <Setter Property="Foreground" Value="#90FFFFFF"/>
                                <Setter TargetName="Chevron" Property="Visibility" Value="Visible"/>
                            </Trigger>

                            <!-- Open state -->
                            <Trigger Property="IsDropDownOpen" Value="True">
                                <Setter TargetName="MainBorder" Property="Background" Value="#20FFFFFF"/>
                                <Setter Property="Foreground" Value="#FFFFFF"/>
                                <Setter TargetName="Chevron" Property="Visibility" Value="Visible"/>
                                <Setter TargetName="Chevron" Property="Stroke" Value="#90FFFFFF"/>
                                <Setter TargetName="Chevron" Property="RenderTransform">
                                    <Setter.Value>
                                        <RotateTransform Angle="180"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>

            <!-- Item container style -->
            <Setter Property="ItemContainerStyle">
                <Setter.Value>
                    <Style TargetType="ComboBoxItem">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="Foreground" Value="#B0FFFFFF"/>
                        <Setter Property="FontSize" Value="11"/>
                        <Setter Property="Padding" Value="10,6"/>
                        <Setter Property="Cursor" Value="Hand"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ComboBoxItem">
                                    <Border x:Name="ItemBorder"
                                            Background="{TemplateBinding Background}"
                                            CornerRadius="4"
                                            Padding="{TemplateBinding Padding}">
                                        <ContentPresenter/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="ItemBorder" Property="Background" Value="#30FFFFFF"/>
                                            <Setter Property="Foreground" Value="#FFFFFF"/>
                                        </Trigger>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter TargetName="ItemBorder" Property="Background" Value="#25FFFFFF"/>
                                            <Setter Property="Foreground" Value="#FFFFFF"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <!-- Main Container with rounded corners and shadow -->
    <Border x:Name="MainBorder"
            CornerRadius="12"
            Background="#E6202020"
            BorderBrush="#40FFFFFF"
            BorderThickness="1"
            Margin="10"
            MouseLeftButtonDown="Border_MouseLeftButtonDown">

        <Border.Effect>
            <DropShadowEffect BlurRadius="15"
                              ShadowDepth="0"
                              Opacity="0.5"
                              Color="Black"/>
        </Border.Effect>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header with status indicator -->
            <Border Grid.Row="0"
                    Padding="12,10"
                    Background="#20FFFFFF"
                    CornerRadius="12,12,0,0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Status indicator (animated pulse when listening) -->
                    <Ellipse Grid.Column="0"
                             Style="{StaticResource StatusIndicatorStyle}"
                             Margin="0,0,10,0"/>

                    <!-- Waveform visualization (visible only when listening) -->
                    <StackPanel x:Name="WaveformPanel"
                                Grid.Column="1"
                                Orientation="Horizontal"
                                VerticalAlignment="Center"
                                Margin="0,0,10,0"
                                Height="20"
                                Visibility="{Binding IsListening, Converter={StaticResource BoolToVisibilityConverter}}">
                        <Rectangle Style="{StaticResource WaveBarStyle}"
                                   Height="{Binding AudioLevel1}"/>
                        <Rectangle Style="{StaticResource WaveBarStyle}"
                                   Height="{Binding AudioLevel2}"/>
                        <Rectangle Style="{StaticResource WaveBarStyle}"
                                   Height="{Binding AudioLevel3}"/>
                        <Rectangle Style="{StaticResource WaveBarStyle}"
                                   Height="{Binding AudioLevel4}"/>
                        <Rectangle Style="{StaticResource WaveBarStyle}"
                                   Height="{Binding AudioLevel5}"/>
                    </StackPanel>

                    <!-- Status text -->
                    <TextBlock Grid.Column="2"
                               Text="{Binding StatusText}"
                               Foreground="#CCFFFFFF"
                               FontSize="13"
                               FontWeight="SemiBold"
                               VerticalAlignment="Center"/>

                    <!-- Header buttons -->
                    <StackPanel Grid.Column="3" Orientation="Horizontal">
                        <!-- Copy button -->
                        <Button x:Name="CopyButton"
                                Style="{StaticResource CloseButtonStyle}"
                                Click="CopyButton_Click"
                                ToolTip="Copy text to clipboard"
                                Margin="0,0,4,0">
                            <Path Data="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"
                                  Fill="#80FFFFFF"
                                  Stretch="Uniform"
                                  Width="12" Height="12"/>
                        </Button>

                        <!-- Close button -->
                        <Button Content="x"
                                Style="{StaticResource CloseButtonStyle}"
                                Click="CloseButton_Click"
                                ToolTip="Hide overlay (Ctrl+Ctrl to show)"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Transcription text area -->
            <ScrollViewer Grid.Row="1"
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled"
                          Padding="14,8">
                <TextBlock x:Name="TranscriptionText"
                           Text="{Binding TranscriptionText}"
                           Foreground="White"
                           FontSize="15"
                           TextWrapping="Wrap"
                           LineHeight="22"/>
            </ScrollViewer>

            <!-- Footer with provider and language selectors -->
            <Border Grid.Row="2"
                    Padding="12,6"
                    Background="#15000000"
                    CornerRadius="0,0,12,12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Provider selector -->
                    <ComboBox Grid.Column="0"
                              Style="{StaticResource GhostChipComboBoxStyle}"
                              ItemsSource="{Binding AvailableProviders}"
                              SelectedItem="{Binding SelectedProvider, Mode=TwoWay}"
                              DropDownOpened="ComboBox_DropDownOpened"
                              DropDownClosed="ComboBox_DropDownClosed"
                              ToolTip="Speech Provider"/>

                    <!-- Language selector -->
                    <ComboBox Grid.Column="1"
                              Style="{StaticResource GhostChipComboBoxStyle}"
                              ItemsSource="{Binding AvailableLanguages}"
                              SelectedItem="{Binding SelectedLanguage, Mode=TwoWay}"
                              DropDownOpened="ComboBox_DropDownOpened"
                              DropDownClosed="ComboBox_DropDownClosed"
                              HorizontalAlignment="Center"
                              FontWeight="SemiBold"
                              ToolTip="Recognition Language"/>

                    <!-- Hotkey hint -->
                    <TextBlock Grid.Column="2"
                               Text="Ctrl+Ctrl to toggle"
                               Foreground="#50FFFFFF"
                               FontSize="10"
                               VerticalAlignment="Center"/>
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>
